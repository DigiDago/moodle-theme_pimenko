{"version":3,"file":"catalog.min.js","sources":["../src/catalog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @copyright  Pimenko 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/config'], function($, ajax, templates, cfg) {\n    let categorySelect = $('#page-course-index-category .categoryselect .urlselect .custom-select');\n    let tagSelect = $('#page-course-index-category .tagselect .urlselect .custom-select');\n    let categorySearch = $('#page-course-index-category form.simplesearchform input');\n\n    let startQuery = function() {\n        categorySelect.attr(\"disabled\", \"true\");\n        tagSelect.attr(\"disabled\", \"true\");\n        categorySearch.attr(\"disabled\", \"true\");\n        $('#course-gallery').attr(\"style\", \"opacity: 0.25;\");\n        $('#loader-gallery').attr(\"style\", \"display: flex;\");\n    };\n\n    let endQuery = function(nbCourses) {\n        categorySelect.removeAttr(\"disabled\");\n        tagSelect.removeAttr(\"disabled\");\n        categorySearch.removeAttr(\"disabled\");\n        $('#course-gallery').attr(\"style\", \"opacity: 1;\");\n        $('#loader-gallery').attr(\"style\", \"display: none;\");\n        let buttonLoadMore = $('#load-more');\n        if (nbCourses > 12) {\n            buttonLoadMore.show();\n        }\n\n        buttonLoadMore.click(function() {\n            let courses = document.getElementsByClassName('course-gallery');\n            let nbCourseMore = 1;\n            for (let i in courses) {\n                if (courses.item(parseInt(i)).style.display === 'none') {\n                    if (nbCourseMore <= 6) {\n                        courses.item(parseInt(i)).style.display = 'flex';\n                        if (parseInt(i) === courses.length - 1) {\n                            $('#load-more').hide();\n                        }\n                        nbCourseMore++;\n                    } else {\n                        break;\n                    }\n                }\n            }\n        });\n    };\n\n    let doQuery = function(response) {\n        if (typeof (response) != 'undefined') {\n            let courses = response.courses;\n            let toDestroy;\n            let nbCourse = 1;\n            let template = {};\n            for (let i in courses) {\n                // Url of picture.\n                if (courses[i].overviewfiles[0] && courses[i].overviewfiles[0].fileurl) {\n                    courses[i].urlimg = courses[i].overviewfiles[0].fileurl.replace(\"webservice\\/\", \"\");\n                }\n\n                courses[i].name = courses[i].fullname;\n                courses[i].category = courses[i].categoryname;\n                courses[i].rootpath = cfg.wwwroot;\n                if (courses[i].enrollmentmethods.includes(\"synopsispaypal\")) {\n                    courses[i].url = cfg.wwwroot + '/enrol/synopsispaypal/index.php?id=' + courses[i].id;\n                } else if (courses[i].enrollmentmethods.includes(\"synopsis\")) {\n                    courses[i].url = cfg.wwwroot + '/enrol/synopsis/index.php?id=' + courses[i].id;\n                } else {\n                    courses[i].url = cfg.wwwroot + '/course/view.php?id=' + courses[i].id;\n                }\n\n                if (nbCourse <= 12) {\n                    courses[i].display = \"flex\";\n                } else {\n                    courses[i].display = \"none\";\n                }\n                nbCourse++;\n\n                // Course 1 to remove.\n                if (courses[i].id === 1) {\n                    toDestroy = i;\n                }\n            }\n            // Remove the course 1 of moodle.\n            if (toDestroy) {\n                courses.splice(toDestroy, 1);\n            }\n            if (courses.length > 12) {\n                template.loadmore = true;\n            }\n\n            template.courses = courses;\n\n            // Rendering of results.\n            templates.render('theme_pimenko/course_gallery', template)\n                .then(function(html) {\n                    let element = document.getElementById('course-gallery');\n                    let parent = element.parentElement;\n                    parent.removeChild(element);\n                    parent.children[parent.children.length - 1].insertAdjacentHTML('beforebegin', html);\n                    endQuery(courses.length);\n                }).fail(function(ex) {\n                /* eslint no-console: \"off\" */\n                console.error(ex);\n                endQuery();\n            });\n        }\n    };\n\n    let eventcatalog = function() {\n        categorySelect.change(function() {\n            let href = categorySelect.val();\n            categorySearch.val(\"\");\n            // Call the method returning the course having the category selected.\n            if (href !== \"all\") {\n                document.location.href = href;\n            } else {\n                document.location.href = \"/course/index.php\";\n            }\n        });\n\n        tagSelect.change(function() {\n            let href = tagSelect.val();\n            categorySearch.val(\"\");\n            // Call the method returning the course having the category selected.\n            if (href !== \"all\") {\n                document.location.href = href;\n            } else {\n                document.location.href = \"/course/index.php\";\n            }\n        });\n\n        $('#page-course-index-category form.simplesearchform').submit(function(event) {\n            event.preventDefault();\n            event.stopPropagation();\n\n            if (categorySearch.val() === '') {\n                document.location.href = \"/course/index.php\";\n            }\n\n            let searchargs = {\n                criterianame: 'search',\n                criteriavalue: categorySearch.val(),\n                page: 0,\n                perpage: 100\n            };\n\n            let promises = ajax.call([\n                {methodname: 'theme_pimenko_search_courses', args: searchargs}\n            ]);\n\n            startQuery();\n\n            promises[0].done(function(response) {\n                doQuery(response);\n                categorySelect.val(\"all\");\n                tagSelect.val('/course/index.php?tagid=0');\n            }).fail(function(ex) {\n                /* eslint no-console: \"off\" */\n                console.log(ex);\n                console.error('search_courses : ' + ex.exception.message);\n            });\n        });\n\n        $('#load-more').click(function() {\n            let courses = document.getElementsByClassName('course-gallery');\n            let nbCourseMore = 1;\n            for (let i in courses) {\n                if (courses.item(parseInt(i)).style.display === 'none') {\n                    if (nbCourseMore <= 12) {\n                        courses.item(parseInt(i)).style.display = 'flex';\n                        if (parseInt(i) === courses.length - 1) {\n                            $('#load-more').hide();\n                        }\n                        nbCourseMore++;\n                    } else {\n                        break;\n                    }\n                }\n            }\n        });\n    };\n\n    return {\n        init: function() {\n            eventcatalog();\n        }\n    };\n});\n"],"names":["define","$","ajax","templates","cfg","categorySelect","tagSelect","categorySearch","endQuery","nbCourses","removeAttr","attr","buttonLoadMore","show","click","courses","document","getElementsByClassName","nbCourseMore","i","item","parseInt","style","display","length","hide","eventcatalog","change","href","val","location","submit","event","preventDefault","stopPropagation","searchargs","criterianame","criteriavalue","page","perpage","promises","call","methodname","args","done","response","toDestroy","nbCourse","template","overviewfiles","fileurl","urlimg","replace","name","fullname","category","categoryname","rootpath","wwwroot","enrollmentmethods","includes","url","id","splice","loadmore","render","then","html","element","getElementById","parent","parentElement","removeChild","children","insertAdjacentHTML","fail","ex","console","error","doQuery","log","exception","message","init"],"mappings":"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"}