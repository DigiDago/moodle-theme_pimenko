{"version":3,"file":"catalog.min.js","sources":["../src/catalog.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @copyright  Pimenko 2019\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/config'], function($, ajax, templates, cfg) {\n    // General filter.\n    let categorySelect = $('#page-course-index-category .categoryselect .urlselect .custom-select');\n    let tagSelect = $('#page-course-index-category .tagselect .urlselect .custom-select');\n    let categorySearch = $('#page-course-index-category .searchcourse form.simplesearchform input');\n    let categoryidselect = $(\"input[name='categoryid']\");\n    // Custom field filter.\n    let customfieldSearch = $('#page-course-index-category .customfieldsearch form');\n    let customfieldDate = $('#page-course-index-category .customfielddate form select');\n    let customfieldSelect = $('#page-course-index-category .customfieldselect form select');\n    let resetbutton = $('#page-course-index-category button.btn[data-filteraction=\\'reset\\']');\n\n    let startQuery = function() {\n        categorySelect.attr(\"disabled\", \"true\");\n        tagSelect.attr(\"disabled\", \"true\");\n        categorySearch.attr(\"disabled\", \"true\");\n        customfieldSearch.attr(\"disabled\", \"true\");\n        customfieldDate.attr(\"disabled\", \"true\");\n        customfieldSelect.attr(\"disabled\", \"true\");\n        resetbutton.attr(\"disabled\", \"true\");\n        $('#course-gallery').attr(\"style\", \"opacity: 0.25;\");\n        $('#loader-gallery').attr(\"style\", \"display: flex;\");\n    };\n\n    let endQuery = function(nbCourses) {\n        categorySelect.removeAttr(\"disabled\");\n        tagSelect.removeAttr(\"disabled\");\n        categorySearch.removeAttr(\"disabled\");\n        customfieldSearch.removeAttr(\"disabled\");\n        customfieldDate.removeAttr(\"disabled\");\n        customfieldSelect.removeAttr(\"disabled\");\n        resetbutton.removeAttr(\"disabled\");\n        $('#course-gallery').attr(\"style\", \"opacity: 1;\");\n        $('#loader-gallery').attr(\"style\", \"display: none;\");\n        let buttonLoadMore = $('#load-more');\n        if (nbCourses > 12) {\n            buttonLoadMore.show();\n        }\n\n        buttonLoadMore.click(function() {\n            let courses = document.getElementsByClassName('course-gallery');\n            let nbCourseMore = 1;\n            for (let i in courses) {\n                if (courses.item(parseInt(i)).style.display === 'none') {\n                    if (nbCourseMore <= 6) {\n                        courses.item(parseInt(i)).style.display = 'flex';\n                        if (parseInt(i) === courses.length - 1) {\n                            $('#load-more').hide();\n                        }\n                        nbCourseMore++;\n                    } else {\n                        break;\n                    }\n                }\n            }\n        });\n    };\n\n    let doQuery = function(response) {\n        if (typeof (response) != 'undefined') {\n            let courses = response.courses;\n            let toDestroy;\n            let nbCourse = 1;\n            let template = {};\n            for (let i in courses) {\n                // Url of picture.\n                if (courses[i].overviewfiles[0] && courses[i].overviewfiles[0].fileurl) {\n                    courses[i].urlimg = courses[i].overviewfiles[0].fileurl.replace(\"webservice\\/\", \"\");\n                }\n\n                courses[i].name = courses[i].fullname;\n                courses[i].category = courses[i].categoryname;\n                courses[i].rootpath = cfg.wwwroot;\n                if (courses[i].enrollmentmethods.includes(\"synopsispaypal\")) {\n                    courses[i].url = cfg.wwwroot + '/enrol/synopsispaypal/index.php?id=' + courses[i].id;\n                } else if (courses[i].enrollmentmethods.includes(\"synopsis\")) {\n                    courses[i].url = cfg.wwwroot + '/enrol/synopsis/index.php?id=' + courses[i].id;\n                } else {\n                    courses[i].url = cfg.wwwroot + '/course/view.php?id=' + courses[i].id;\n                }\n\n                if (nbCourse <= 12) {\n                    courses[i].display = \"flex\";\n                } else {\n                    courses[i].display = \"none\";\n                }\n                nbCourse++;\n\n                // Course 1 to remove.\n                if (courses[i].id === 1) {\n                    toDestroy = i;\n                }\n            }\n            // Remove the course 1 of moodle.\n            if (toDestroy) {\n                courses.splice(toDestroy, 1);\n            }\n            if (courses.length > 12) {\n                template.loadmore = true;\n            }\n\n            template.courses = courses;\n\n            // Rendering of results.\n            templates.render('theme_pimenko/course_gallery', template, 'theme_pimenko').then(function(html) {\n                let element = document.getElementById('course-gallery');\n                let parent = element.parentElement;\n                parent.removeChild(element);\n                parent.insertAdjacentHTML('beforebegin', html);\n                endQuery(courses.length);\n            }).fail(function(ex) {\n                /* eslint no-console: \"off\" */\n                console.error(ex);\n                endQuery();\n            });\n        }\n    };\n\n    let eventcatalog = function() {\n        categorySelect.change(function() {\n            let href = categorySelect.val();\n            categorySearch.val(\"\");\n\n            if (href !== \"all\") {\n                document.location.href = href;\n            } else {\n                document.location.href = \"/course/index.php\";\n            }\n        });\n\n        customfieldSearch.submit(function(event) {\n            event.preventDefault();\n            event.stopPropagation();\n\n            let href = this.action;\n            let value = this.querySelector('input').value;\n\n            if (value === \"\") {\n                href = href + '&customfieldvalue=all';\n                document.location.href = href;\n            } else {\n                href = href + '&customfieldvalue=' + value;\n                document.location.href = href;\n            }\n        });\n\n        customfieldDate.change(function() {\n\n            let parent = this.form;\n            let datevalues = new FormData(parent);\n            let href = parent.action;\n            let categoryid = false;\n\n            if (categoryidselect) {\n                categoryid = categoryidselect.val();\n            }\n\n            let datatype = parent.closest('.customfielddate').dataset.name;\n\n            href = href + '?customfieldselected=' + datatype + '&day=' +\n                datevalues.get('date_selector[day]') +\n                '&month=' + datevalues.get('date_selector[month]') +\n                '&year=' + datevalues.get('date_selector[year]');\n\n            if (categoryid) {\n                href = href + '&categoryid=' + categoryid;\n            }\n\n            document.location.href = href;\n        });\n\n        resetbutton.click(function() {\n            document.location.href = \"/course/index.php\";\n        });\n\n        $('#page-course-index-category .searchcourse form.simplesearchform').submit(function(event) {\n            event.preventDefault();\n            event.stopPropagation();\n\n            let categoryid = 0;\n\n            if (categoryidselect) {\n                categoryid = categoryidselect.val();\n            }\n\n            let searchargs = {\n                criterianame: 'search',\n                criteriavalue: categorySearch.val(),\n                categoryid: categoryid,\n                page: 0,\n                perpage: 100\n            };\n\n            let promises = ajax.call([\n                {methodname: 'theme_pimenko_search_courses', args: searchargs}\n            ]);\n\n            startQuery();\n\n            promises[0].done(function(response) {\n                tagSelect.prop('selectedIndex', 0);\n                customfieldSearch.prop('selectedIndex', 0);\n                customfieldDate.prop('selectedIndex', 0);\n                customfieldSelect.prop('selectedIndex', 0);\n                doQuery(response);\n            }).fail(function(ex) {\n                /* eslint no-console: \"off\" */\n                console.log(ex);\n                console.error('search_courses : ' + ex.exception.message);\n            });\n        });\n\n        $('#load-more').click(function() {\n            let courses = document.getElementsByClassName('course-gallery');\n            let nbCourseMore = 1;\n            for (let i in courses) {\n                if (courses.item(parseInt(i)).style.display === 'none') {\n                    if (nbCourseMore <= 12) {\n                        courses.item(parseInt(i)).style.display = 'flex';\n                        if (parseInt(i) === courses.length - 1) {\n                            $('#load-more').hide();\n                        }\n                        nbCourseMore++;\n                    } else {\n                        break;\n                    }\n                }\n            }\n        });\n    };\n\n    return {\n        init: function() {\n            eventcatalog();\n        }\n    };\n});\n"],"names":["define","$","ajax","templates","cfg","categorySelect","tagSelect","categorySearch","categoryidselect","customfieldSearch","customfieldDate","customfieldSelect","resetbutton","endQuery","nbCourses","removeAttr","attr","buttonLoadMore","show","click","courses","document","getElementsByClassName","nbCourseMore","i","item","parseInt","style","display","length","hide","eventcatalog","change","href","val","location","submit","event","preventDefault","stopPropagation","this","action","value","querySelector","parent","form","datevalues","FormData","categoryid","closest","dataset","name","get","searchargs","criterianame","criteriavalue","page","perpage","promises","call","methodname","args","done","response","prop","toDestroy","nbCourse","template","overviewfiles","fileurl","urlimg","replace","fullname","category","categoryname","rootpath","wwwroot","enrollmentmethods","includes","url","id","splice","loadmore","render","then","html","element","getElementById","parentElement","removeChild","insertAdjacentHTML","fail","ex","console","error","doQuery","log","exception","message","init"],"mappings":"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"}